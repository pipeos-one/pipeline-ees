<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
 <!-- Font Awesome -->
 <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  
<style>
html,  body, main, #draw {
    width: 100%;
    height: 100%;
    margin: auto;
}


</style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <link rel="stylesheet" href="https://raw.githubusercontent.com/daneden/animate.css/master/animate.css">
    <link rel="stylesheet" href="css/mdb.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <link rel="stylesheet" href="css/js-offcanvas.css">

    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet"></link>


    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script src="https://peterolson.github.io/BigInteger.js/BigInteger.min.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.13/svg.min.js" integrity="sha256-lGl8w8KbUgg+8cFC38Erx5NRwynFuqFLvdwkdR9ggjM=" crossorigin="anonymous"></script>
      <!-- <script src="js/svg.draggable.js"></script> -->

      <script src="js/sanct/sanctuary-show/index.js"></script>
      <script src="js/sanct/sanctuary-type-identifiers/index.js"></script>
      <script src="js/sanct/sanctuary-type-classes/index.js"></script>
      <script src="js/sanct/sanctuary-either/index.js"></script>
      <script src="js/sanct/sanctuary-maybe/index.js"></script>
      <script src="js/sanct/sanctuary-pair/index.js"></script>
      <script src="js/sanct/sanctuary-def/index.js"></script>
      <script src="js/sanct/sanctuary/index.js"></script>
      <script src="js/data.js"></script>
     

      

    <title>Pipeline</title>

</head>

<body>
<main class="c-offcanvas-content-wrap" role="main">
<div id="draw"></div>

    <div class="fixed-bottom justify-content-between d-flex">
        <button class="js-offcanvas-trigger btn btn-primary" data-offcanvas-trigger="left" href="#left"><i class="fas fa fa-bars"></i></button>
        <button class="js-offcanvas-trigger btn btn-primary" data-offcanvas-trigger="top" href="#top"><i class="fas fa fa-bars"></i></button>
        <button class="js-offcanvas-trigger btn btn-primary" data-offcanvas-trigger="right" href="#right"><i class="fas fa fa-bars"></i></button></div>

</main>


<aside class="js-offcanvas" data-offcanvas-options='{"modifiers":"left, overlay"}' id="left" role="complementary">

        <div id="carousel-example" class="carousel slide" data-interval="false" data-ride="carousel">
            <nav aria-label="breadcrumb">
                        <ol class="breadcrumb" id="breadcrumbs">
                                <li class="breadcrumb-item"><a href="#">Menu</a></li>
                        </ol>
            </nav>


            <div class="carousel-inner row w-100 mx-auto" role="listbox" id="caruso">
                <div class="carousel-item active">
                            <ul class="list-group">
                                    <li class="list-group-item justify-content-between align-items-center">
                                    Add Node
                                            <button type="button" data-slide="next" role="button" class="list-group-item-action d-flex  carousel-control-next" href="#carousel-example" > <span class="badge badge-primary badge-pill">14</span>
                                    </button>
                                    </li>

            <li class="list-group-item justify-content-between align-items-center">
                Find Node by Type
                        <button type="button" id="bytype" role="button"  > ->
                </button>
            </li>

                                    <li class="list-group-item justify-content-between align-items-center">
                                        Set Constant
                                    <button type="button" onclick="constFill()" role="button" >Go</button>
                                            </li>
                            </ul>
                </div>
            </div>

        </div>
    
</aside>



<aside class="js-offcanvas" data-offcanvas-options='{"modifiers":"top, overlay"}' id="top" role="complementary">
        <form class="text-center" style="color: #757575;" action="#!">
    <table class="justify-content-between container-fluid">
            <tbody class="justify-content-between container-fluid">
        <tr>
        <td><ul class="list-group" id="run_in"></ul></td>
        <td>&gt;</td>

            <td valign="top"><ul class="list-group" id="run_out"></ul></td>
        </tr>
            </tbody>
    </table>
        </form>
   
</aside>


<aside class="js-offcanvas" data-offcanvas-options='{"modifiers":"right, overlay"}' id="right" role="complementary">
        <button type="button" onclick="save_graph()" role="button" >Save Graph as Function</button>
    
</aside>


  
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script src="js/js-offcanvas.pkgd.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <script>

// var r_offc  = $('#right').data('offcanvas-component');
// var l_offc  = $('#left').data('offcanvas-component');
// var t_offc  = $('#top')[0].data('offcanvas-component');
// // console.log("ttt", t_offc)
// //.data('offcanvas-component');

// t_offc.onOpen = function() {
//     // console.log('Callback onOpen');
//     let m  =""

//     m =  m+'<div class="md-form mb-5">  <input type="text" id="form32" class="form-control validate"><label data-error="wrong" data-success="right" for="form32">'+name+'</label> </div>'

//     $("#top").html(m)

// };

// const instance = axios.create({
//   baseURL: 'http://192.168.1.140:3001'
// });

var s = settings  ={}
s.start = null
s.end  = null
s.graph = 0

//var dataOffcanvas
function slideCanvas(){
    $( document ).bind( "beforecreate.offcanvas", function( e ){
        var dataOffcanvas = $( e.target ).data('offcanvas-component');
        // console.log(dataOffcanvas);
        dataOffcanvas.onInit =  function() {
            // console.log(this);
        };
    } );
    $( document ).bind( "create.offcanvas", function( e ){
        var dataOffcanvas = $( e.target ).data('offcanvas-component');
        // console.log(dataOffcanvas);
        dataOffcanvas.onOpen =  function() {
            // console.log('Callback onOpen');
        };
        dataOffcanvas.onClose =  function() {
            // console.log('Callback onClose');
        };

    } );
    $( document ).bind( "clicked.offcanvas-trigger clicked.offcanvas", function( e ){
        var dataBtnText = $( e.target ).text();
        // console.log(e.type + '.' + e.namespace + ': ' + dataBtnText);
    } );
    $( document ).bind( "open.offcanvas", function( e ){
        var dataOffcanvasID = $( e.target ).attr('id');
        // console.log(e.type + ': #' + dataOffcanvasID);
        if (dataOffcanvasID  == "top") fillTop()
    } );
    $( document ).bind( "resizing.offcanvas", function( e ){
        var dataOffcanvasID = $( e.target ).attr('id');
        // console.log(e.type + ': #' + dataOffcanvasID);
    } );
    $( document ).bind( "close.offcanvas", function( e ){
        var dataOffcanvasID = $( e.target ).attr('id');
        // console.log(e.type + ': #' + dataOffcanvasID);
    } );
    // $( '#right' ).bind( "create.offcanvas", function( e ){
    //     var dataOffcanvas = $(this).data('offcanvas-component');
    //     setTimeout(function(){
    //         //dataOffcanvas.open();
    //     }, 500);

    // } );
    $( document ).trigger( "enhance" );
}

slideCanvas()


//$("#menu").hide()
var visible =false;

var menu= {
    name: "Menu",
    size: 45,
    children: [
        {
            name: "fdggggfuuggg",
            size: 13,
            children: [
                {
                    name: "fdggguuiuyggg454",
                    size: 13,
                    children: [
                {
                    name: "fgghgggg454",
                    size: 13
                },
                {
                    name: "child2365",
                    size:2
                }
            ]
                },
                {
                    name: "child2365",
                    size:2
                }
            ]
        },
        {
            name: "child2",
            size:2
        }
    ]
}

var menus = {}, new_instaces = 100

function constFill(){
    let m  = ""
    ndx = 0
    // console.log("constfill")

    

    S.map (element => {
        //let port = indexed_func[nodes[ndx].id].pfunction.gapi.outputs[0]
        m = m + '<div class="md-form"><input type="text" class="form-control" onchange="const1($(this).attr(\'data-id\'))" id="c_'+ndx+'" data-type="any" data-id="'+ndx+'" value="'+JSON.stringify(element)+'"><label for="c_'+ndx+'">Constant  '+ndx+'</label></div>'
        ndx++
    }) (graph.r); 

    m  = m + '<div class="md-form"><input type="text" class="form-control" onchange="const1($(this).attr(\'data-id\'))" id="c_'+ndx+'" data-type="any"  data-id="'+ndx+'" data-name="" value="'+JSON.stringify(element)+'"><label for="c_'+ndx+'">New Constant </label></div>'
    // console.log("lhh",JSON.stringify(m))
    $("#caruso").html(m)


}



function save_graph(){
    // console.log(graph)
    var win = window.open("insertFunc.html?graph="+encodeURIComponent(JSON.stringify(graph.init)), '_blank');
    win.focus();

}

function const1(ndx) {
    let val 
    try {
        val = JSON.parse("["+$("#c_"+ndx).val()+"]")[0]
    } catch (error) {
        val = JSON.parse("[\""+$("#c_"+ndx).val()+"\"]")[0]
    }
    // console.log(val)
    graph.init.r[ndx] = val
    // console.log(s)
    if (s.end)  {
        graph.init.e.push( [0, 1+parseInt(ndx)].concat(s.end.data("key")))
        // console.log(graph.init)
        s.start  = s.end = null
    }
    gr   =  graph.init
    doit2()
}


function fillTop(){
    let m  ="", n=""
    let nodes = graph.n
    let ndx =  3000
    while ( nodes[ndx] != undefined) {
        // console.log(nodes[ndx].id, indexed_func[nodes[ndx].id])
        let port = indexed_func[nodes[ndx].id].pfunction.gapi.outputs[0]
        m = m + '<div class="md-form"><input type="text" class="form-control" onkeyup="processGraph()" id="in_'+ndx+'" data-type="'+port.type+'" data-name="'+port.name+'"><label for="in_'+ndx+'">'+port.name+": "+port.type+'</label></div>'
        //m =  m+'<div class="md-form">  <input type="text" onkeyup="processGraph()" id="in_'+ndx+'" class="form-control validate" data-type="'+port.type+'" data-name="'+port.name+'"><label data-error="wrong" data-success="right" for="form32">'+port.name+": "+port.type+'</label> </div>'
        ndx++
    }

    ndx = 0

    S.map (element => {
        let port  = 0
        S.map (edge => {
            console.log(edge, element)
            if (edge[0] === 0 && ndx == edge[1]-1) {
                
                let port = indexed_func[nodes[edge[2]].id].pfunction.gapi.inputs[edge[3]-1]
                console.log(edge, element, port,  indexed_func[nodes[edge[2]].id])
                m = m + '<div class="md-form"><input type="text" class="form-control" onkeyup="processGraph()" id="r_'+ndx+'" data-type="'+port.type+'" data-name="'+port.name+'" value=\''+JSON.stringify(element).replace(/\"/g,"")+'\'><label for="r_'+ndx+'">Const: '+port.name+": "+port.type+'</label></div>'
            }
        })  (graph.e)
        //let port = indexed_func[nodes[ndx].id].pfunction.gapi.outputs[0]
        
        ndx++
    }) (graph.r); 

    ndx = 4000
    while ( nodes[ndx] != undefined) {
        let port = indexed_func[nodes[ndx].id].pfunction.gapi.inputs[0]
        n = n + '<div class="md-form"><input type="text"class="form-control"  id="out_'+ndx+'" data-type="'+port.type+'" data-name="'+port.name+'"><label for="out_'+ndx+'">'+port.name+": "+port.type+'</label></div>'
        //n =  n+'<div class="md-form mb-5">  <input type="text" id="out_'+ndx+'" class="form-control validate"><label data-error="wrong" data-success="right" for="form32">'+port.name+": "+port.type+'</label> </div>'
        ndx++
    }
    // console.log(m)

    $("#run_in").html(m)
    $("#run_out").html(n)
    
}

function processGraph(){
    let ndx = 3000
    let args = {}
    let temp = null
    while ($('#in_'+ndx).val()) {
        temp = $('#in_'+ndx).val()
        temp = temp.replace("“", '"')
        temp = temp.replace("“" , '"')
        // console.log("argsss",temp)
        
        if ($('#in_'+ndx).attr("data-type") == "function") {
            
            temp =  new Function("return "+temp)();
        } else {
            temp = JSON.parse(temp)
        }
        //// console.log("lll",temp)
        args[""+ndx] = temp
        ndx++
    }

    ndx = 0 

    while ($('#r_'+ndx).val()) {
        temp = $('#r_'+ndx).val()
        temp = temp.replace("“", '"')
        temp = temp.replace("“" , '"')

        try {
            temp = JSON.parse("["+temp+"]")[0]
        } catch (error) {
            temp = JSON.parse("[\""+temp+"\"]")[0]
        }

        graph.r[ndx] = temp
        ndx++
    }


    // console.log("args",args)
    let func =  make_runtime (indexed_func) (graph)
    let ans = run_graph (func) (args)
    console.log("final_func",func,  args,ans)

    ndx =4000

    while ($('#out_'+ndx).length) {
        //// console.log("argst",temp)
        $('#out_'+ndx).val(JSON.stringify(ans[""+(4000-ndx)]))
        ndx++
    }

    // console.log(ans)
}

function add1Menu(){
    let menu2 = {
        name: "Add Node",
        size: indexed_func.length,
        children: indexed_func
      }

      fillMenu2(menu2, "caruso", "breadcrumbs")
}

function fillMenu2(data, divId , divid2){
    let div = $("#"+divId)
    // console.log(data)
    let div2  = $("#"+divid2)
    div2.append('<li class="breadcrumb-item"><a href="#">'+data.name+'</a></li>')
    let m  = "", el
    m= m+'<div class="carousel-item"><ul class="list-group">'
    for (element  in data.children) {
        // console.log(element)
        el = data.children[element]
        m = m+'<li class="list-group-item justify-content-between align-items-center"><button type="button" data-slide="next"  onClick="fx1($(this).attr(\'data-id\'))" data-id="'+element+'"  role="button" class="btn" ><i class="fas fa fa-bars"></i></button><button type="button" data-slide="next"  onClick="fx2($(this).attr(\'data-id\'))" data-id="'+element+'"  role="button" class="btn" ><i class="fas fa fa-bars"></i></button> '+el.pfunction.signature
        if (el.children !== undefined)  {
            m = m + '<button type="button" data-slide="next"  onClick="goTo($(this).attr(\'data-id\'))" data-id="'+element+'"  role="button" class="list-group-item-action d-flex  carousel-control-next" href="#carousel-example" > <span class="badge badge-primary badge-pill">'+el.children.length+'</span></button>'
        }
        m= m+' </li>'
        menus[element.name] = element
    };
    m= m+ '</ul></div>'
    div.append(m)
    $('.carousel').carousel({ interval: false })//.carousel('refresh');
}



function goTo(e){
    // console.log(menus[e])
    fillMenu(menus[e], "caruso", "breadcrumbs")
    $('.carousel').carousel({ interval: false }).carousel('next')
}

function fx1(e){
    // console.log("fx1: "+e)

    //$( document ).dispatchEvent(new Event("clicked.offcanvas"))
    $( document ).trigger( "enhance" );
    visible  = false
    new_instaces++

    gr[s.graph] = add_node(graph.init) ({i: new_instaces, id: e})
    gr[s.graph] = enrich_graph (indexed_func) (gr[s.graph])
    graph = gr[s.graph]
    //run_gr = make_runtime (indexed_func) (graph)
    doit2()

}

function fx2(e){
    // console.log("fx2: "+e)
}


function bytype() {
    let io = false, type
    if (s.start) {
        io = "inputs"
        type = s.start.data("type")
    }
    
    if (s.end) {
        io = "outputs"
        type = s.end.data("type")
    }

    if (io) {
        getTypes(io  , type)
    }

}

$("#bytype").click(bytype)

function getTypes(io  , type){
    let req = "/pfunction?filter={%22where%22:{%22pfunction.gapi."+io+".type%22:%22"+type+"%22}}"
    console.log(req)
    instance.get(req)
      .then(function (response) {
        // console.log("response",response);
        out = response.data
        console.log("response",out);

        fillMenu({children: out}, "caruso", "breadcrumbs")
        $("#carousel").carousel('next')

      })
      .catch(function (error) {
        // console.log(error);
      });

}

$("#b_menu").click( x => { 
    if (visible) {
        $("#menu").hide()
        visible  = false
    } else {
        $("#menu").show()
        visible   =true
    }
});

$("#b_menu1").click( x => { 
    $(".mobile_menu").simpleMobileMenu({
            onMenuLoad: function(menu) {
                // console.log(menu)
                // console.log("menu loaded")
            },
            onMenuToggle: function(menu, opened) {
                // console.log(opened)
            },
            "menuStyle": "slide"
        });
});

draw = SVG().addTo('#draw').size("100%", "100%")
let texts = draw.group()




</script>

<script src="js/pipeshow.js"></script>
</body>

</html>